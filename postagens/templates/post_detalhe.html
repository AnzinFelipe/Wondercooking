{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'postagens/css/detalhe.css' %}">
{% endblock %}

{% block conteudo %}
<div class="container">
  <div class="post-detalhe-grid">
    
    <aside class="pd-left">
      <h1 class="pd-title">{{ post.titulo }}</h1>

      {% if post.imagem %}
        {% if post.imagem.url %}
          <img class="pd-image" src="{{ post.imagem.url }}" alt="{{ post.titulo }}">
        {% else %}
          <div class="pd-image placeholder">Sem imagem</div>
        {% endif %}
      {% else %}
        <div class="pd-image placeholder">Sem imagem</div>
      {% endif %}

      <p class="pd-meta">
        <strong>Autor:</strong>
        {% if post.autor and post.autor.user %}
          {{ post.autor.user.username }}
        {% else %}
          An√¥nimo
        {% endif %}
      </p>

      <p class="pd-meta"><strong>Postado em:</strong> {{ post.data|date:"d/m/Y H:i" }}</p>
    </aside>

    <section class="pd-right">

      <div class="pd-body">
        <div class="richtext">{{ post.descricao|linebreaks }}</div>
      </div>

      <div class="pd-comments">
        <h3>Coment√°rios</h3>

        {% if user.is_authenticated %}
          <form class="coment-form" method="POST" action="{% url 'post_detalhe' post.id %}">
            {% csrf_token %}
            <label for="texto">Deixe um coment√°rio:</label>
            <textarea name="texto" id="texto" required></textarea>
            <button type="submit">Publicar</button>
            {% if erro %}
              <p style="color:red;">{{ erro }}</p>
            {% endif %}
          </form>
        {% else %}
          <p>Fa√ßa <a href="{% url 'login' %}">login</a> para comentar.</p>
        {% endif %}

        {% if comentarios %}
          <div class="comentarios-list">
            {% for comentario in comentarios %}
              <div class="comentario">
                <div class="comentario-cabecalho">
                  <p><strong>
                    {% if comentario.usuario and comentario.usuario.user %}
                      {{ comentario.usuario.user.username }}
                    {% else %}
                      Usu√°rio desconhecido
                    {% endif %}
                  </strong></p>
                  <p class="comentario-data">{{ comentario.data|date:"d/m/Y H:i" }}</p>
                </div>
                <p>{{ comentario.texto|linebreaks }}</p>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p>Seja a primeira pessoa a comentar!</p>
        {% endif %}
      </div>

      <div id="post-{{ post.id }}" class="pd-actions">
        {% if user.is_authenticated %}
          <form method="post" action="{% url 'like_post' post.id %}">
            {% csrf_token %}
            <button type="submit" class="btn-like">
              {% if request.user in post.likes.all %}üëç Curtido{% else %}üëç Curtir{% endif %}
              ({{ post.likes.count }})
            </button>
          </form>

          <form method="post" action="{% url 'favorite_post' post.id %}">
            {% csrf_token %}
            <button type="submit" class="btn-fav">
              {% if request.user in post.favoritos.all %}‚òÖ Favoritado{% else %}‚òÜ Favoritar{% endif %}
            </button>
          </form>
        {% else %}
          <a class="btn-like" href="{% url 'login' %}">üëç Curtir</a>
          <a class="btn-fav"  href="{% url 'login' %}">‚òÜ Favoritar</a>
        {% endif %}

        <div class="voltar-container">
          <a href="{% url 'home' %}" class="btn-voltar">Voltar</a>
        </div>
      </div>
    </section>
  </div>
</div>
{% endblock %}
